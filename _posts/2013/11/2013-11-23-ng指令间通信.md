---
layout: post
title: ng中指令间通信
categories:
- programming
tag:
- AngularJS
---

本文又是一学习的笔记，亦是翻译贴，有兴趣的请移驾原文。  
[Communication Between Directives in AngularJS](http://thesmithfam.org/blog/2012/12/17/communicating-between-directives-in-angularjs/)

## 预备知识
在读本文前，你至少需要对以下几个知识点有些了解：

- Directive
- Scope
- Controller
- 往控制器中注入service
- ng-show | ng-hide
- ng-click
- ng-model
-ng-repeat

## Roadmap

1. 创建第一个指令，分析它的每一行代码
2. 通过scope对象将指令链到控制器上
3. 创建第二个指令，把它和前者连一起

## 创建并分析第一个指令
我们创建的第一个指令要做的事情是：一个搜索的输入框。我们在 `app.js` 文件夹中定义最初的版本，如下：

{% highlight javascript %}
// app.js
angular.module('myApp', []).
    directive('mySearchBox', function() {
        return {
            restrict: 'E',
            replace: true,
            template: '<span>My custom search box</span>'
        };
    });
{% endhighlight %}

上面的代码应该比较直观，不懂的只好回去恶补一下了，就不像原文那样一行行讲了，有兴趣的可以看原文了。其中有一点就是 `template` 可以用 `templateUrl` 替代，并且博主也建议最好是从 CDN 或者一个快速的cache去取的，而不是很慢的server端产生的partial。那好，现在，我们就可以在 `index.html` 文件中启动angular并用上面自定义的指令了。

{% highlight html %}
<html ng-app="myApp">
  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.3/angular.min.js"></script>
    <script src="app.js"></script>
  </head>
  <body> 
      <my-search-box></my-search-box>
  </body>
</html>
{% endhighlight %}

*上代码唯一要注意的就是在 `app.js` 中定义的指令是驼峰写法，在html文件中要换成dash连接的写法*。当然啦，到目前为止，这个指令啥用没有。

## 给你的指令属于它自己的的私人空间
所谓私人空间，就是给指令自己的scope。每个指令的DOM实例对象都有自己的scope，而这个scope可能是外面控制器scope的子级scope，比如像下面的例子，两个自定义指令产生了两个scope，都是控制器`myCtrl`产生的scope的孩子。

{% highlight html %}
<body ng-controller="myCtrl"> 
    <my-search-box></my-search-box>
    <my-search-box></my-search-box>
</body>
{% endhighlight %}

**Q**：现在，如何让指令和外部通信呢？  
**A**：通过指令定义时加入一个 `scope` 属性。

{% highlight javascript %}
// app.js
angular.module('myApp', []).
    directive('mySearchBox', function() {
        return {
            restrict: 'E',
            replace: true,
            scope: {
                searchText: '=',
                isSearching: '='
            },
            template: '<span>My custom search box</span>'
        };
    });
{% endhighlight %}

上面 `scope` 属性被置为一个对象，而这个对象里面又有两个属性，**这两个属性告诉angular，但凡用到这个指令的，可以在指令标签中使用这两个属性，而且这两个属性与它们被赋值的变量进行了双向绑定**，也就是说，用户可以像下面代码一样用上面这个指令：

{% highlight html %}
<my-search-box
    search-text="someScopeVar" 
    is-searching="someOhterScopeVar">
</my-search-box>
{% endhighlight %}

**上面呢，就是你如何让指令和外部通信的一个方法了，而且非常好用的**。上面所看到的两个外部的变量 `someScopeVar` 和 `someOtherScopeVar` 常常就是在外围的控制器中维护的。当然啦，仅仅只是上面定义的指令，我们还是无法让指令自己拥有的scope为我们所用，还需要对别的地方进行修改，看下面的代码：

{% highlight javascript %}
angular.module("MyApp", []).
  directive('mySearchBox', function() {
    return {
      restrict: 'E',
      scope: {
        searchText: '=',
        isSearching: '='
      },
      controller: function($scope) {
        $scope.localSearchText = '';
        $scope.clearSearch = function() {
          $scope.searchText = "";
          $scope.localSearchText = "";
        };
        $scope.doSearch = function() {
          $scope.searchText = $scope.localSearchText;
        };
      },
      replace: true,
      template:
      '<form>' +
        '<div>' +
          '<input ng-model="localSearchText" type="text" />' +
        '</div>' +
        '<div>' +
          '<button ng-click="clearSearch()" class="btn btn-small">Clear</button>' +
          '<button ng-click="doSearch()" class="btn btn-small">Search</button>' +
        '</div> ' +
        '<div ng-show="isSearching">' +
          '<img ng-show="isSearching" src="http://loadinggif.com/images/image-selection/3.gif" /> ' +
          'Searching...' +
        '</div>' +
      '</form>'
    };
  })
{% endhighlight %}

如果你的模版像上面这样看起来那么多了，我们建议是时候用 `templateUrl` 了。当然，这里仅是示范使用。那么上面的代码多了什么呢？

- 指令里面出现了属于指令自己的控制器，这样，我们的自定义指令可以去响应用户的输入和用户交互了，在这里面可以用 `$scope` 对象引用到之前做了双向绑定的两个变量
- 模版中可以写angular的指令，并且可以调用指令下的控制器中定义的方法
- $scope 中多维护了一个变量，就是用户输入通过 `ng-model` 指令与我们自定义指令中进行了一个双向绑定，这样我们在自定义指令中可以随时捕获用户的输入了
- 维护一个用户输入是为了让我们等用户真正完成了所有输入并点击搜索时我们才把这个值赋值给 `searchText` ，这样可以避免在用户每敲一次键盘，我们就得去触发一次search，这是不科学的

**Q**：到这里了，我们还是没有提到指令自己的scope中的两个属性到底绑定的是外面的什么东西，和什么东西通信，快告诉我们吧，急死我了。
**A**：骚年，莫着急，这就来，绑定的是外围的控制器，这个搜索框，毕竟还是要通过外围控制器的刺激才能开工的